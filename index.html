<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrbitAlign | Satellite Dish Alignment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #0f172a;
        }
        body {
            background-color: var(--bg);
            color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        /* Mobile-friendly touch targets */
        @media (max-width: 640px) {
            input, button, .dropdown-item {
                min-height: 44px;
            }
        }
        /* Satellite visibility indicator */
        .sat-visible {
            border-left: 3px solid #22c55e;
        }
        .sat-hidden {
            border-left: 3px solid #ef4444;
            opacity: 0.6;
        }
        /* Region badge colors */
        .region-americas { background-color: #3b82f6; }
        .region-europe { background-color: #8b5cf6; }
        .region-asia { background-color: #f59e0b; }
        .region-oceania { background-color: #10b981; }
        .region-africa { background-color: #ef4444; }
        .region-global { background-color: #6b7280; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-20">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold tracking-tight text-white mb-2">OrbitAlign</h1>
            <p class="text-slate-400 italic">Precision satellite dish alignment tool</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Inputs -->
            <div class="space-y-6">
                <!-- Location Card -->
                <section class="card p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Your Position
                        </h2>
                        <button id="geoBtn" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-full transition-all flex items-center gap-1 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Use GPS
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Latitude</label>
                            <input type="number" id="userLat" step="any" placeholder="-33.8688" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <span class="text-[10px] text-slate-500 mt-1 block">Negative = South</span>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Longitude</label>
                            <input type="number" id="userLon" step="any" placeholder="151.2093" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <span class="text-[10px] text-slate-500 mt-1 block">Negative = West</span>
                        </div>
                    </div>
                </section>

                <!-- Satellite Search Card -->
                <section class="card p-6 rounded-2xl shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Satellite Target
                    </h2>

                    <!-- Filter Options -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                            <input type="checkbox" id="filterVisible" class="rounded bg-slate-800 border-slate-600 text-amber-500 focus:ring-amber-500">
                            <span>Show only visible satellites</span>
                        </label>
                    </div>

                    <!-- Region Filter -->
                    <div class="flex flex-wrap gap-1 mb-4">
                        <button class="region-filter text-[10px] px-2 py-1 rounded-full bg-slate-700 text-white" data-region="all">All</button>
                        <button class="region-filter text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-400" data-region="oceania">Oceania</button>
                        <button class="region-filter text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-400" data-region="asia">Asia</button>
                        <button class="region-filter text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-400" data-region="europe">Europe</button>
                        <button class="region-filter text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-400" data-region="americas">Americas</button>
                    </div>

                    <!-- Search Input with Clear Button -->
                    <div class="relative mb-4">
                        <input type="text" id="satSearch" placeholder="Search or select a satellite..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-amber-500 outline-none pr-20">
                        
                        <!-- Clear button (shown when there's text) -->
                        <button id="clearSatBtn" class="hidden absolute right-10 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white p-1" title="Clear selection">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        
                        <!-- Dropdown toggle arrow -->
                        <button id="dropdownToggle" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        
                        <!-- Dropdown - high z-index to appear above other elements -->
                        <div id="satDropdown" class="hidden absolute left-0 right-0 top-full mt-1 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-[100] max-h-72 overflow-y-auto custom-scrollbar">
                            <!-- Items populated by JS -->
                        </div>
                    </div>

                    <!-- Manual Satellite Position Input -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Orbital Position (Longitude)</label>
                        <div class="flex gap-2">
                            <input type="number" id="satLon" step="any" placeholder="Enter orbital longitude" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-amber-500 outline-none">
                            <span class="bg-slate-800 border border-slate-700 rounded-lg px-3 flex items-center text-slate-400 text-sm">°</span>
                        </div>
                        <span class="text-[10px] text-slate-500 mt-1 block">Geostationary orbit longitude (-180° to 180°)</span>
                    </div>
                </section>
            </div>

            <!-- Right Column: Results & Visualization -->
            <div class="space-y-6">
                <!-- Values Card -->
                <div class="card p-6 rounded-2xl shadow-xl">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-4">Dish Alignment Values</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <span class="block text-[10px] uppercase tracking-wider text-slate-500 font-black mb-1">Azimuth</span>
                            <span id="azimuthVal" class="text-2xl font-mono text-blue-400">--°</span>
                            <span class="block text-[10px] text-slate-600 mt-1">from True North</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-[10px] uppercase tracking-wider text-slate-500 font-black mb-1">Elevation</span>
                            <span id="elevationVal" class="text-2xl font-mono text-green-400">--°</span>
                            <span class="block text-[10px] text-slate-600 mt-1">above horizon</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-[10px] uppercase tracking-wider text-slate-500 font-black mb-1">Skew</span>
                            <span id="skewVal" class="text-2xl font-mono text-amber-400">--°</span>
                            <span class="block text-[10px] text-slate-600 mt-1">LNB rotation</span>
                        </div>
                    </div>
                    
                    <!-- Warning for below horizon -->
                    <div id="horizonWarning" class="hidden mt-4 p-3 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 text-xs text-center">
                        ⚠️ Satellite is below your horizon and cannot be received from this location.
                    </div>
                    
                    <!-- Success indicator -->
                    <div id="visibleIndicator" class="hidden mt-4 p-3 bg-green-900/30 border border-green-500/50 rounded-lg text-green-200 text-xs text-center">
                        ✓ Satellite is visible from your location
                    </div>
                </div>

                <!-- Visualizers -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Compass View -->
                    <div class="card p-6 rounded-2xl flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-500 uppercase mb-4">Compass View</span>
                        <div class="relative w-32 h-32">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="48" fill="none" stroke="#1e293b" stroke-width="4" />
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#334155" stroke-width="1" stroke-dasharray="2 2" />
                                <!-- Degree markers -->
                                <text x="50" y="12" text-anchor="middle" font-size="8" font-weight="bold" fill="#64748b" transform="rotate(90, 50, 50)">N</text>
                                <text x="88" y="53" text-anchor="middle" font-size="8" font-weight="bold" fill="#64748b" transform="rotate(90, 50, 50)">E</text>
                                <text x="50" y="94" text-anchor="middle" font-size="8" font-weight="bold" fill="#64748b" transform="rotate(90, 50, 50)">S</text>
                                <text x="12" y="53" text-anchor="middle" font-size="8" font-weight="bold" fill="#64748b" transform="rotate(90, 50, 50)">W</text>
                            </svg>
                            <div id="compassNeedle" class="absolute inset-0 flex items-center justify-center transition-transform duration-1000 ease-out" style="transform: rotate(0deg);">
                                <div class="w-1.5 h-16 bg-gradient-to-t from-transparent via-blue-500 to-blue-400 rounded-full shadow-[0_0_15px_rgba(59,130,246,0.5)]"></div>
                            </div>
                        </div>
                        <span id="compassDegrees" class="text-xs text-slate-400 mt-2">--°</span>
                    </div>

                    <!-- Elevation View -->
                    <div class="card p-6 rounded-2xl flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-500 uppercase mb-4">Elevation View</span>
                        <div class="relative w-32 h-32 flex items-end justify-center bg-slate-900/30 rounded-full border border-slate-800 overflow-hidden">
                            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                            <div class="absolute bottom-0 w-full h-0.5 bg-slate-700"></div>
                            <!-- Horizon line label -->
                            <span class="absolute bottom-1 right-2 text-[8px] text-slate-600">Horizon</span>
                            <div id="elevationNeedle" class="absolute bottom-0 left-1/2 w-32 h-1.5 bg-green-500 origin-left transition-transform duration-1000 ease-out" style="transform: translateX(0) rotate(0deg);">
                                <div class="absolute -right-2 -top-4 w-6 h-10 bg-green-400/80 rounded border border-green-300"></div>
                            </div>
                        </div>
                        <span id="elevationDegrees" class="text-xs text-slate-400 mt-2">--°</span>
                    </div>
                </div>

                <!-- Skew Diagram -->
                <div class="card p-6 rounded-2xl">
                    <span class="text-[10px] font-black text-slate-500 uppercase mb-4 block text-center">LNB Skew Rotation</span>
                    <div class="flex items-center justify-center gap-4">
                        <span class="text-xs text-slate-500">CCW</span>
                        <div class="relative w-20 h-20">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="#334155" stroke-width="2" />
                                <circle cx="50" cy="50" r="35" fill="#1e293b" />
                                <!-- Reference line (vertical) -->
                                <line x1="50" y1="15" x2="50" y2="30" stroke="#475569" stroke-width="2" />
                            </svg>
                            <div id="skewIndicator" class="absolute inset-0 flex items-center justify-center transition-transform duration-1000 ease-out" style="transform: rotate(0deg);">
                                <div class="w-1 h-10 bg-amber-400 rounded-full" style="transform: translateY(-5px);"></div>
                            </div>
                        </div>
                        <span class="text-xs text-slate-500">CW</span>
                    </div>
                    <p class="text-[10px] text-slate-500 text-center mt-3">
                        <span id="skewDirection">--</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer with explanation -->
        <footer class="mt-8 text-slate-500 text-[11px] card p-4 rounded-xl leading-relaxed space-y-2">
            <p><strong>How to use:</strong></p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li><strong>Azimuth:</strong> Point your dish in this compass direction (True North). Adjust for local magnetic declination if using a magnetic compass.</li>
                <li><strong>Elevation:</strong> Tilt your dish up by this angle from horizontal.</li>
                <li><strong>Skew:</strong> Rotate your LNB by this angle. Positive = clockwise when looking at the dish from behind.</li>
            </ul>
            <p class="mt-2 text-slate-600">Tip: Green border on satellites indicates they are visible from your location.</p>
        </footer>
    </div>

    <!-- Feedback Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 opacity-0 pointer-events-none transition-all duration-300 translate-y-4 z-[100]">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700 flex items-center gap-3">
            <span id="toastIcon"></span>
            <span id="toastMsg"></span>
        </div>
    </div>

    <script>
        // =====================================================
        // SATELLITE DATABASE
        // Comprehensive list organized by region
        // lon = orbital longitude (positive = East, negative = West)
        // =====================================================
        const satellites = [
            // --- OCEANIA / AUSTRALIA / NEW ZEALAND ---
            { name: "Optus D1", lon: 160.0, region: "oceania", desc: "Australia - Foxtel/FTA" },
            { name: "Optus D2", lon: 152.0, region: "oceania", desc: "Australia - Primary DTH" },
            { name: "Optus D3", lon: 156.0, region: "oceania", desc: "Australia - Backup/Services" },
            { name: "Optus C1/D3", lon: 156.0, region: "oceania", desc: "Australia - SBS/ABC" },
            { name: "NBN Co 1A (Sky Muster)", lon: 140.0, region: "oceania", desc: "Australia - NBN Broadband" },
            { name: "NBN Co 1B (Sky Muster II)", lon: 143.5, region: "oceania", desc: "Australia - NBN Broadband" },
            { name: "Intelsat 18", lon: 180.0, region: "oceania", desc: "Pacific Region" },
            { name: "Intelsat 19", lon: 166.0, region: "oceania", desc: "Pacific/Oceania" },
            
            // --- ASIA / MALAYSIA / SOUTHEAST ASIA ---
            { name: "MEASAT 3", lon: 91.5, region: "asia", desc: "Malaysia - Astro DTH" },
            { name: "MEASAT 3a", lon: 91.5, region: "asia", desc: "Malaysia - Astro HD" },
            { name: "MEASAT 3b", lon: 91.5, region: "asia", desc: "Malaysia - Astro Services" },
            { name: "MEASAT 3d", lon: 91.5, region: "asia", desc: "Malaysia - Latest Astro" },
            { name: "Apstar 6", lon: 134.0, region: "asia", desc: "Asia-Pacific DTH" },
            { name: "Apstar 7", lon: 76.5, region: "asia", desc: "Asia/Middle East" },
            { name: "Apstar 9", lon: 142.0, region: "asia", desc: "Asia-Pacific" },
            { name: "AsiaSat 5", lon: 100.5, region: "asia", desc: "Asia - Video Distribution" },
            { name: "AsiaSat 7", lon: 105.5, region: "asia", desc: "Asia - Primary DTH" },
            { name: "AsiaSat 9", lon: 122.0, region: "asia", desc: "Asia - HD Services" },
            { name: "Thaicom 4 (IPSTAR)", lon: 119.5, region: "asia", desc: "Thailand - Broadband" },
            { name: "Thaicom 6", lon: 78.5, region: "asia", desc: "Thailand/Africa" },
            { name: "Thaicom 8", lon: 78.5, region: "asia", desc: "Thailand - DTH" },
            { name: "SES-7 (Protostar 2)", lon: 108.2, region: "asia", desc: "Southeast Asia" },
            { name: "SES-8", lon: 95.0, region: "asia", desc: "South Asia/Southeast Asia" },
            { name: "SES-9", lon: 108.2, region: "asia", desc: "Asia-Pacific" },
            { name: "SES-12", lon: 95.0, region: "asia", desc: "Asia-Pacific HTS" },
            { name: "Intelsat 17", lon: 66.0, region: "asia", desc: "Indian Ocean" },
            { name: "Intelsat 20", lon: 68.5, region: "asia", desc: "Indian Ocean/Africa" },
            { name: "Palapa D", lon: 113.0, region: "asia", desc: "Indonesia" },
            { name: "Telkom 3S", lon: 118.0, region: "asia", desc: "Indonesia" },
            { name: "JCSAT 2B", lon: 154.0, region: "asia", desc: "Japan" },
            { name: "Koreasat 5", lon: 113.0, region: "asia", desc: "Korea" },
            { name: "Koreasat 6", lon: 116.0, region: "asia", desc: "Korea" },
            { name: "ChinaSat 6B", lon: 115.5, region: "asia", desc: "China" },
            { name: "ChinaSat 9", lon: 92.2, region: "asia", desc: "China DTH" },
            { name: "ABS-2", lon: 75.0, region: "asia", desc: "Asia/Russia/MENA" },
            { name: "Yamal 402", lon: 55.0, region: "asia", desc: "Russia/Asia" },
            
            // --- EUROPE / MIDDLE EAST / AFRICA ---
            { name: "Astra 19.2E", lon: 19.2, region: "europe", desc: "Europe - Sky DE/FR" },
            { name: "Astra 28.2E", lon: 28.2, region: "europe", desc: "UK/Ireland - Sky UK" },
            { name: "Astra 23.5E", lon: 23.5, region: "europe", desc: "Europe - Beam" },
            { name: "Astra 4A", lon: 5.0, region: "europe", desc: "Northern Europe" },
            { name: "Eutelsat Hot Bird 13B", lon: 13.0, region: "europe", desc: "Europe FTA" },
            { name: "Eutelsat Hot Bird 13C", lon: 13.0, region: "europe", desc: "Europe FTA" },
            { name: "Eutelsat Hot Bird 13E", lon: 13.0, region: "europe", desc: "Europe FTA" },
            { name: "Eutelsat 9B", lon: 9.0, region: "europe", desc: "Europe" },
            { name: "Eutelsat 7A", lon: 7.0, region: "europe", desc: "Turkey/Africa" },
            { name: "Eutelsat 5 West A", lon: -5.0, region: "europe", desc: "France/Italy" },
            { name: "Eutelsat 8 West B", lon: -8.0, region: "europe", desc: "MENA/Africa" },
            { name: "Thor 5/6", lon: 0.8, region: "europe", desc: "Nordic countries" },
            { name: "Türksat 4A", lon: 42.0, region: "europe", desc: "Turkey" },
            { name: "Türksat 4B", lon: 50.0, region: "europe", desc: "Turkey/Asia" },
            { name: "Arabsat 5C", lon: 20.0, region: "europe", desc: "Middle East" },
            { name: "Arabsat 6A", lon: 30.5, region: "europe", desc: "Middle East" },
            { name: "Badr 4/5/6/7", lon: 26.0, region: "europe", desc: "Middle East - MBC" },
            { name: "Nilesat 201", lon: 7.0, region: "europe", desc: "Egypt/MENA" },
            { name: "Es'hail 2 (QO-100)", lon: 25.9, region: "europe", desc: "Qatar - Amateur Radio" },
            
            // --- AMERICAS ---
            { name: "Viasat 1", lon: -115.1, region: "americas", desc: "USA - Broadband" },
            { name: "Viasat 2", lon: -69.9, region: "americas", desc: "Americas - Broadband" },
            { name: "Viasat 3 Americas", lon: -88.9, region: "americas", desc: "Americas - HTS" },
            { name: "HughesNet Jupiter 1 (EchoStar XVII)", lon: -107.1, region: "americas", desc: "USA - Broadband" },
            { name: "HughesNet Jupiter 2 (EchoStar XIX)", lon: -97.1, region: "americas", desc: "USA - Broadband" },
            { name: "HughesNet Jupiter 3 (EchoStar XXIV)", lon: -95.0, region: "americas", desc: "Americas - HTS" },
            { name: "DirecTV 10/12/15", lon: -103.0, region: "americas", desc: "USA - DirecTV" },
            { name: "DirecTV 11/14", lon: -99.0, region: "americas", desc: "USA - DirecTV" },
            { name: "Dish Network 129W", lon: -129.0, region: "americas", desc: "USA - Dish Network" },
            { name: "Dish Network 119W", lon: -119.0, region: "americas", desc: "USA - Dish Network" },
            { name: "Dish Network 110W", lon: -110.0, region: "americas", desc: "USA - Dish Network" },
            { name: "Galaxy 19", lon: -97.0, region: "americas", desc: "USA - FTA" },
            { name: "Galaxy 16", lon: -99.0, region: "americas", desc: "USA - Cable feeds" },
            { name: "SES-1", lon: -101.0, region: "americas", desc: "USA" },
            { name: "SES-2", lon: -87.0, region: "americas", desc: "USA" },
            { name: "SES-3", lon: -103.0, region: "americas", desc: "USA" },
            { name: "Anik F2", lon: -111.1, region: "americas", desc: "Canada" },
            { name: "Anik F3", lon: -118.7, region: "americas", desc: "Canada" },
            { name: "Amazonas 2", lon: -61.0, region: "americas", desc: "Latin America" },
            { name: "Amazonas 5", lon: -61.0, region: "americas", desc: "Latin America" },
            { name: "Star One C2/C4", lon: -70.0, region: "americas", desc: "Brazil" },
            { name: "Star One D1", lon: -84.0, region: "americas", desc: "Brazil" },
            { name: "Intelsat 21", lon: -58.0, region: "americas", desc: "Latin America" },
            { name: "Intelsat 30/DLA-1", lon: -95.0, region: "americas", desc: "Latin America - SKY Mexico" },
            { name: "Hispasat 30W-5", lon: -30.0, region: "americas", desc: "Spain/Americas" },
            { name: "Telstar 12V", lon: -15.0, region: "americas", desc: "Atlantic" },
            
        ].sort((a, b) => a.name.localeCompare(b.name));

        // =====================================================
        // DOM ELEMENTS
        // =====================================================
        const geoBtn = document.getElementById('geoBtn');
        const userLatEl = document.getElementById('userLat');
        const userLonEl = document.getElementById('userLon');
        const satLonEl = document.getElementById('satLon');
        const satSearch = document.getElementById('satSearch');
        const satDropdown = document.getElementById('satDropdown');
        const clearSatBtn = document.getElementById('clearSatBtn');
        const dropdownToggle = document.getElementById('dropdownToggle');
        const filterVisibleCheckbox = document.getElementById('filterVisible');

        const azDisplay = document.getElementById('azimuthVal');
        const elDisplay = document.getElementById('elevationVal');
        const skewDisplay = document.getElementById('skewVal');
        const compassNeedle = document.getElementById('compassNeedle');
        const compassDegrees = document.getElementById('compassDegrees');
        const elevationNeedle = document.getElementById('elevationNeedle');
        const elevationDegrees = document.getElementById('elevationDegrees');
        const skewIndicator = document.getElementById('skewIndicator');
        const skewDirection = document.getElementById('skewDirection');
        const horizonWarning = document.getElementById('horizonWarning');
        const visibleIndicator = document.getElementById('visibleIndicator');

        // State
        let selectedRegion = 'all';

        // =====================================================
        // MATH HELPER FUNCTIONS
        // =====================================================
        
        // Convert degrees to radians
        function toRad(deg) { 
            return deg * (Math.PI / 180); 
        }
        
        // Convert radians to degrees
        function toDeg(rad) { 
            return rad * (180 / Math.PI); 
        }

        // =====================================================
        // CORE SATELLITE POSITION CALCULATIONS
        // 
        // These formulas calculate the look angles (azimuth, elevation, skew)
        // from a ground location to a geostationary satellite.
        // 
        // Geostationary satellites orbit at ~35,786 km above the equator,
        // with an orbital radius of ~42,164 km from Earth's center.
        // =====================================================

        /**
         * Calculate if a satellite is visible from a given location
         * A geostationary satellite is visible if elevation > 0°
         * 
         * @param {number} userLat - User latitude in degrees
         * @param {number} userLon - User longitude in degrees
         * @param {number} satLon - Satellite longitude in degrees
         * @returns {object} - Contains elevation and visibility boolean
         */
        function calculateVisibility(userLat, userLon, satLon) {
            const elevation = calculateElevation(userLat, userLon, satLon);
            return {
                elevation: elevation,
                isVisible: elevation > 0
            };
        }

        /**
         * Calculate elevation angle to satellite
         * 
         * Formula: el = arctan((cos(L)*cos(ΔG) - r) / sqrt(1 - (cos(L)*cos(ΔG))²))
         * 
         * Where:
         * - L = user latitude
         * - ΔG = difference in longitude (user - satellite)
         * - r = ratio of Earth radius to satellite orbital radius
         * 
         * @param {number} userLat - User latitude in degrees
         * @param {number} userLon - User longitude in degrees  
         * @param {number} satLon - Satellite longitude in degrees
         * @returns {number} - Elevation angle in degrees (negative = below horizon)
         */
        function calculateElevation(userLat, userLon, satLon) {
            const L = toRad(userLat);
            const deltaG = toRad(userLon - satLon);
            
            // Earth's equatorial radius (km)
            const R_earth = 6378.14;
            // Geostationary orbital radius from Earth's center (km)
            const R_sat = 42164.0;
            // Ratio of radii
            const r = R_earth / R_sat;
            
            const cosL = Math.cos(L);
            const cosDeltaG = Math.cos(deltaG);
            
            // The term cos(L)*cos(ΔG) represents the cosine of the central angle
            // between the observer and the sub-satellite point
            const cosCentralAngle = cosDeltaG * cosL;
            
            // Calculate elevation
            const numerator = cosCentralAngle - r;
            const denominator = Math.sqrt(1 - Math.pow(cosCentralAngle, 2));
            
            // Handle edge case when satellite is directly overhead
            if (denominator === 0) {
                return 90; // Directly overhead
            }
            
            return toDeg(Math.atan(numerator / denominator));
        }

        /**
         * Calculate azimuth angle to satellite (from True North)
         * 
         * This uses atan2 for proper quadrant handling.
         * 
         * The basic formula: Az = 180° + arctan(tan(ΔG) / sin(L))
         * 
         * But we need to handle special cases:
         * - At the equator (L=0), azimuth is 90° (East) or 270° (West)
         * - The quadrant depends on which hemisphere and satellite position
         * 
         * @param {number} userLat - User latitude in degrees
         * @param {number} userLon - User longitude in degrees
         * @param {number} satLon - Satellite longitude in degrees
         * @returns {number} - Azimuth angle in degrees (0-360, clockwise from North)
         */
        function calculateAzimuth(userLat, userLon, satLon) {
            const L = toRad(userLat);
            const deltaG = toRad(userLon - satLon); // Positive = satellite is West of user
            
            // Special case: user at equator
            if (Math.abs(userLat) < 0.001) {
                // At equator, azimuth is simply East (90°) or West (270°)
                if (deltaG > 0) {
                    return 270; // Satellite is to the West
                } else if (deltaG < 0) {
                    return 90; // Satellite is to the East
                } else {
                    return 180; // Satellite directly above (pointing South for convention)
                }
            }
            
            // Use atan2 for proper quadrant handling
            // atan2(y, x) where y = tan(deltaG), x = sin(L)
            const azRad = Math.atan2(Math.tan(deltaG), Math.sin(L));
            let azimuth = toDeg(azRad);
            
            // Convert to compass bearing (0-360 from North)
            // Northern hemisphere: add 180° to get bearing from North
            // Southern hemisphere: normalize to 0-360
            if (userLat >= 0) {
                azimuth = azimuth + 180;
            } else {
                // Southern hemisphere
                if (azimuth < 0) {
                    azimuth = azimuth + 360;
                }
            }
            
            // Ensure result is in 0-360 range
            azimuth = ((azimuth % 360) + 360) % 360;
            
            return azimuth;
        }

        /**
         * Calculate LNB polarization skew angle
         * 
         * The skew angle compensates for the rotation of the satellite's
         * polarization plane relative to the observer's position.
         * 
         * Formula: skew = arctan(sin(ΔG) / tan(L))
         * 
         * Positive skew = rotate LNB clockwise (when looking at dish from behind)
         * Negative skew = rotate LNB counter-clockwise
         * 
         * @param {number} userLat - User latitude in degrees
         * @param {number} userLon - User longitude in degrees
         * @param {number} satLon - Satellite longitude in degrees
         * @returns {number} - Skew angle in degrees
         */
        function calculateSkew(userLat, userLon, satLon) {
            const L = toRad(userLat);
            const deltaG = toRad(userLon - satLon);
            
            // Special case: user at equator (tan(0) = 0, division by zero)
            if (Math.abs(userLat) < 0.001) {
                return 0; // No skew needed at equator
            }
            
            // Special case: satellite at same longitude as user
            if (Math.abs(userLon - satLon) < 0.001) {
                return 0; // No skew needed when satellite is due South/North
            }
            
            const skew = toDeg(Math.atan(Math.sin(deltaG) / Math.tan(L)));
            
            return skew;
        }

        /**
         * Main calculation function - calculates all alignment values and updates UI
         * Calculations happen automatically as inputs change, so validation is silent
         */
        function calculateAlignment() {
            const lat = parseFloat(userLatEl.value);
            const lon = parseFloat(userLonEl.value);
            const satLon = parseFloat(satLonEl.value);

            // Silently return if inputs are incomplete or invalid
            // (user may still be typing)
            if (isNaN(lat) || isNaN(lon) || isNaN(satLon)) {
                return;
            }

            // Validate latitude range
            if (lat < -90 || lat > 90) {
                return;
            }

            // Validate longitude range
            if (lon < -180 || lon > 180 || satLon < -180 || satLon > 180) {
                return;
            }

            // Calculate all alignment values
            const azimuth = calculateAzimuth(lat, lon, satLon);
            const elevation = calculateElevation(lat, lon, satLon);
            const skew = calculateSkew(lat, lon, satLon);

            // Update numeric displays
            azDisplay.textContent = azimuth.toFixed(1) + '°';
            elDisplay.textContent = elevation.toFixed(1) + '°';
            skewDisplay.textContent = isFinite(skew) ? skew.toFixed(1) + '°' : '0.0°';

            // Update compass needle and label
            compassNeedle.style.transform = `rotate(${azimuth}deg)`;
            compassDegrees.textContent = azimuth.toFixed(1) + '° ' + getCompassDirection(azimuth);

            // Update elevation display (negative rotation because CSS rotates clockwise)
            const displayElevation = Math.max(-10, Math.min(90, elevation)); // Clamp for display
            elevationNeedle.style.transform = `rotate(${-displayElevation}deg)`;
            elevationDegrees.textContent = elevation.toFixed(1) + '°';

            // Update skew indicator
            skewIndicator.style.transform = `rotate(${skew}deg)`;
            if (Math.abs(skew) < 0.5) {
                skewDirection.textContent = 'No rotation needed';
            } else if (skew > 0) {
                skewDirection.textContent = `Rotate ${Math.abs(skew).toFixed(1)}° clockwise`;
            } else {
                skewDirection.textContent = `Rotate ${Math.abs(skew).toFixed(1)}° counter-clockwise`;
            }

            // Show/hide horizon warning and visibility indicator
            if (elevation < 0) {
                horizonWarning.classList.remove('hidden');
                visibleIndicator.classList.add('hidden');
            } else {
                horizonWarning.classList.add('hidden');
                visibleIndicator.classList.remove('hidden');
            }

            // Update satellite list visibility indicators
            renderDropdown(satSearch.value);
        }

        /**
         * Convert azimuth degrees to compass direction (N, NE, E, etc.)
         */
        function getCompassDirection(azimuth) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                               'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(azimuth / 22.5) % 16;
            return directions[index];
        }

        // =====================================================
        // SATELLITE SEARCH & DROPDOWN LOGIC
        // =====================================================

        /**
         * Render the satellite dropdown with filtering and visibility indicators
         */
        function renderDropdown(filter = "") {
            const userLat = parseFloat(userLatEl.value);
            const userLon = parseFloat(userLonEl.value);
            const hasLocation = !isNaN(userLat) && !isNaN(userLon);
            const showOnlyVisible = filterVisibleCheckbox.checked;
            
            // Filter satellites based on search text and region
            let filtered = satellites.filter(s => {
                // Text filter
                const matchesText = s.name.toLowerCase().includes(filter.toLowerCase()) ||
                                   (s.desc && s.desc.toLowerCase().includes(filter.toLowerCase()));
                
                // Region filter
                const matchesRegion = selectedRegion === 'all' || s.region === selectedRegion;
                
                return matchesText && matchesRegion;
            });
            
            // Add visibility info to each satellite
            filtered = filtered.map(sat => {
                if (hasLocation) {
                    const visibility = calculateVisibility(userLat, userLon, sat.lon);
                    return { ...sat, isVisible: visibility.isVisible, elevation: visibility.elevation };
                }
                return { ...sat, isVisible: null };
            });
            
            // Filter by visibility if checkbox is checked
            if (showOnlyVisible && hasLocation) {
                filtered = filtered.filter(sat => sat.isVisible);
            }
            
            // Sort: visible satellites first, then by name
            filtered.sort((a, b) => {
                if (a.isVisible !== b.isVisible) {
                    return a.isVisible ? -1 : 1;
                }
                return a.name.localeCompare(b.name);
            });
            
            // Render dropdown
            satDropdown.innerHTML = '';
            
            if (filtered.length === 0) {
                satDropdown.innerHTML = `
                    <div class="p-4 text-slate-500 text-sm text-center">
                        ${showOnlyVisible ? 'No visible satellites found for your location' : 'No satellites found'}
                    </div>`;
            } else {
                filtered.forEach(sat => {
                    const div = document.createElement('div');
                    
                    // Determine visibility class
                    let visibilityClass = '';
                    let visibilityBadge = '';
                    if (sat.isVisible === true) {
                        visibilityClass = 'sat-visible';
                        visibilityBadge = `<span class="text-[9px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded">visible</span>`;
                    } else if (sat.isVisible === false) {
                        visibilityClass = 'sat-hidden';
                        visibilityBadge = `<span class="text-[9px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded">below horizon</span>`;
                    }
                    
                    // Region badge color
                    const regionColors = {
                        oceania: 'bg-emerald-900/50 text-emerald-400',
                        asia: 'bg-amber-900/50 text-amber-400',
                        europe: 'bg-purple-900/50 text-purple-400',
                        americas: 'bg-blue-900/50 text-blue-400'
                    };
                    const regionBadge = sat.region ? 
                        `<span class="text-[9px] ${regionColors[sat.region] || 'bg-slate-700 text-slate-400'} px-1.5 py-0.5 rounded capitalize">${sat.region}</span>` : '';
                    
                    div.className = `dropdown-item p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50 transition-colors ${visibilityClass}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <span class="text-white font-medium group-hover:text-amber-400 block">${sat.name}</span>
                                <span class="text-[10px] text-slate-500">${sat.desc || ''}</span>
                            </div>
                            <div class="text-right flex flex-col items-end gap-1">
                                <span class="text-xs text-slate-400 font-mono">${sat.lon > 0 ? sat.lon + '°E' : Math.abs(sat.lon) + '°W'}</span>
                                <div class="flex gap-1">
                                    ${regionBadge}
                                    ${visibilityBadge}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    div.onclick = () => selectSatellite(sat);
                    satDropdown.appendChild(div);
                });
            }
        }

        /**
         * Handle satellite selection from dropdown
         */
        function selectSatellite(sat) {
            satLonEl.value = sat.lon;
            satSearch.value = sat.name;
            satDropdown.classList.add('hidden');
            updateClearButton();
            calculateAlignment();
        }

        /**
         * Show/hide the clear button based on search input content
         */
        function updateClearButton() {
            if (satSearch.value.trim()) {
                clearSatBtn.classList.remove('hidden');
            } else {
                clearSatBtn.classList.add('hidden');
            }
        }

        /**
         * Clear the satellite selection and show all satellites
         */
        function clearSatelliteSelection() {
            satSearch.value = '';
            updateClearButton();
            renderDropdown('');
            satDropdown.classList.remove('hidden');
            satSearch.focus();
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================

        // Satellite search input events
        satSearch.onfocus = () => {
            // When focused, show dropdown with current filter OR all if selected
            renderDropdown(satSearch.value);
            satDropdown.classList.remove('hidden');
        };

        satSearch.oninput = (e) => {
            renderDropdown(e.target.value);
            updateClearButton();
            satDropdown.classList.remove('hidden');
        };

        // Clear button click
        clearSatBtn.onclick = (e) => {
            e.stopPropagation();
            clearSatelliteSelection();
        };

        // Dropdown toggle button
        dropdownToggle.onclick = (e) => {
            e.stopPropagation();
            if (satDropdown.classList.contains('hidden')) {
                renderDropdown(satSearch.value);
                satDropdown.classList.remove('hidden');
            } else {
                satDropdown.classList.add('hidden');
            }
        };

        // Visibility filter checkbox
        filterVisibleCheckbox.onchange = () => {
            renderDropdown(satSearch.value);
        };

        // Region filter buttons
        document.querySelectorAll('.region-filter').forEach(btn => {
            btn.onclick = () => {
                // Update selected state
                document.querySelectorAll('.region-filter').forEach(b => {
                    b.classList.remove('bg-slate-700', 'text-white');
                    b.classList.add('bg-slate-800', 'text-slate-400');
                });
                btn.classList.remove('bg-slate-800', 'text-slate-400');
                btn.classList.add('bg-slate-700', 'text-white');
                
                // Update filter and re-render
                selectedRegion = btn.dataset.region;
                renderDropdown(satSearch.value);
                satDropdown.classList.remove('hidden');
            };
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!satSearch.contains(e.target) && 
                !satDropdown.contains(e.target) && 
                !dropdownToggle.contains(e.target) &&
                !clearSatBtn.contains(e.target)) {
                satDropdown.classList.add('hidden');
            }
        });

        // Location input changes - update satellite visibility and recalculate
        userLatEl.oninput = () => {
            // Update satellite visibility in dropdown
            if (satDropdown.classList.contains('hidden') === false) {
                renderDropdown(satSearch.value);
            }
            // Auto-recalculate if we have all inputs
            if (satLonEl.value) {
                calculateAlignment();
            }
        };
        
        userLonEl.oninput = () => {
            // Update satellite visibility in dropdown
            if (satDropdown.classList.contains('hidden') === false) {
                renderDropdown(satSearch.value);
            }
            // Auto-recalculate if we have all inputs
            if (satLonEl.value) {
                calculateAlignment();
            }
        };
        
        // Satellite longitude input - auto-calculate on change
        satLonEl.oninput = () => {
            // Clear the satellite name if user is typing manually
            if (document.activeElement === satLonEl) {
                // Only clear if the value doesn't match a known satellite
                const matchingSat = satellites.find(s => s.lon === parseFloat(satLonEl.value));
                if (!matchingSat) {
                    satSearch.value = '';
                    updateClearButton();
                }
            }
            // Auto-calculate if we have location
            if (userLatEl.value && userLonEl.value) {
                calculateAlignment();
            }
        };

        // =====================================================
        // GPS LOCATION
        // =====================================================

        function showToast(msg, icon = "ℹ️") {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').innerText = icon;
            toast.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
            }, 3000);
        }

        geoBtn.onclick = () => {
            if (!navigator.geolocation) {
                showToast("GPS not supported on this device", "❌");
                return;
            }
            
            // Update button to show loading state
            geoBtn.innerHTML = `
                <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Getting...</span>
            `;
            geoBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userLatEl.value = pos.coords.latitude.toFixed(4);
                    userLonEl.value = pos.coords.longitude.toFixed(4);
                    resetGeoButton();
                    showToast("Location updated!", "✅");
                    
                    // Auto-calculate if satellite is selected
                    if (satLonEl.value) {
                        calculateAlignment();
                    }
                    
                    // Refresh satellite list with visibility
                    renderDropdown(satSearch.value);
                },
                (err) => {
                    let message = "Location access denied";
                    if (err.code === err.TIMEOUT) {
                        message = "Location request timed out";
                    } else if (err.code === err.POSITION_UNAVAILABLE) {
                        message = "Location unavailable";
                    }
                    showToast(message, "⚠️");
                    resetGeoButton();
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                }
            );
        };

        function resetGeoButton() {
            geoBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Use GPS
            `;
            geoBtn.disabled = false;
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        window.onload = () => {
            updateClearButton();
            renderDropdown('');
            
            // Set default location to Sydney, Australia for demo
            if (!userLatEl.value && !userLonEl.value) {
                userLatEl.value = '-33.8688';
                userLonEl.value = '151.2093';
            }
            
            // Auto-calculate if we have all values on load
            if (userLatEl.value && userLonEl.value && satLonEl.value) {
                calculateAlignment();
            }
        };
    </script>
</body>
</html>
